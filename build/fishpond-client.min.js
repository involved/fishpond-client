/*! fishpond-client v0.1.2 | 2014-05-09 */
"bind"in Function.prototype||(Function.prototype.bind=function(a){var b=this;if(arguments.length<=1)return function(){return b.apply(a,arguments)};var c=Array.prototype.slice.call(arguments,1);return function(){return b.apply(a,0===arguments.length?c:c.concat(Array.prototype.slice.call(arguments)))}}),"trim"in String.prototype||(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(a,b){void 0===b&&(b=0),0>b&&(b+=this.length),0>b&&(b=0);for(var c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(a,b){for(void 0===b&&(b=this.length-1),0>b&&(b+=this.length),b>this.length-1&&(b=this.length-1),b++;b-->0;)if(b in this&&this[b]===a)return b;return-1}),"forEach"in Array.prototype||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d>c;c++)c in this&&a.call(b,this[c],c,this)}),"map"in Array.prototype||(Array.prototype.map=function(a,b){for(var c=new Array(this.length),d=0,e=this.length;e>d;d++)d in this&&(c[d]=a.call(b,this[d],d,this));return c}),"filter"in Array.prototype||(Array.prototype.filter=function(a,b){for(var c,d=[],e=0,f=this.length;f>e;e++)e in this&&a.call(b,c=this[e],e,this)&&d.push(c);return d}),"every"in Array.prototype||(Array.prototype.every=function(a,b){for(var c=0,d=this.length;d>c;c++)if(c in this&&!a.call(b,this[c],c,this))return!1;return!0}),"some"in Array.prototype||(Array.prototype.some=function(a,b){for(var c=0,d=this.length;d>c;c++)if(c in this&&a.call(b,this[c],c,this))return!0;return!1});var JSONP=function(){function a(a,b){var c=document.createElement("script"),d=!1;c.src=a,c.async=!0;var f=b||h.error;"function"==typeof f&&(c.onerror=function(b){f({url:a,event:b})}),c.onload=c.onreadystatechange=function(){d||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(d=!0,c.onload=c.onreadystatechange=null,c&&c.parentNode&&c.parentNode.removeChild(c))},e||(e=document.getElementsByTagName("head")[0]),e.appendChild(c)}function b(a){return encodeURIComponent(a)}function c(c,d,e,i){var j,k=-1===(c||"").indexOf("?")?"?":"&";i=i||h.callbackName||"callback";var l=i+"_json"+ ++f;d=d||{};for(j in d)d.hasOwnProperty(j)&&(k+=b(j)+"="+b(d[j])+"&");return g[l]=function(a){e(a);try{delete g[l]}catch(b){}g[l]=null},a(c+k+i+"="+l),l}function d(a){h=a}var e,f=0,g=this,h={};return{get:c,init:d}}();(function(){var a,b=[].slice,c={}.hasOwnProperty;Fishpond.prototype.track=function(a,b,c,d){return this.event_tracking_enabled?(this.log("Tracking: "+a+" | "+b+" | "+c+" | "+d),_gaq.push(["_trackEvent",a,b,c,d])):void 0},a="undefined"!=typeof exports&&null!==exports?exports:this,a.Fishpond=function(){function a(b,c){var d;this.api_key=b,this.options=null!=c?c:{},this.created_at=new Date,this._ready=!1,this.log("Creating fishpond instance"),this.connection=new a.prototype.Connection(this),d=this,this.loading(function(a){return d.log("Loading "+100*a+"%")}),this.ready(function(a){return d.log("Ready to query '"+a+"'")}),this.error(function(a){return d.log("Error"),d.log(a)}),this.resultsUpdated(function(a){return d.log("Results updated"),d.raw_log(a)})}return a.prototype.init=function(b){var c;return this.pond_id=b,c=this,this.log("Init with pond "+this.pond_id),c.trigger("loading",0),this.connection.request(["ponds",this.pond_id],function(b){return c.pond=new a.prototype.Pond(c),c.pond.build(b),c.debug("Loaded pond '"+c.pond+"'"),c.pond.load_all_fish(function(){return c.trigger("loading",1),this._ready=!0,c.log("Ready"),c.trigger("ready",c.pond)})})},a.prototype.trigger=function(){var a,c;return c=arguments[0],a=2<=arguments.length?b.call(arguments,1):[],this.callbacks[c](a[0])},a.prototype.time_alive=function(){return parseInt((new Date-this.created_at)/1e3,10)},a.prototype.enable_event_tracking=function(a,b){var c,d,e,f;return this.event_tracking_enabled=!0,f=f||[],f.push(["_setAccount",a]),f.push(["_setDomainName",b]),f.push(["_setAllowLinker",!0]),f.push(["_trackPageview"]),c=document.createElement("script"),c.type="text/javascript",c.async=!0,e="http://www","https:"===document.location.protocol&&(e="https://ssl"),c.src=""+e+".google-analytics.com/ga.js",d=document.getElementsByTagName("script")[0],d.parentNode.insertBefore(c,d),this.log("Event tracking enabled with ID "+a+" on "+b)},a}(),Fishpond.prototype.loading=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.loading=a},Fishpond.prototype.ready=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.ready=a},Fishpond.prototype.error=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.error=a},Fishpond.prototype.resultsUpdated=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.resultsUpdated=a},Fishpond.prototype.Connection=function(){function a(a){this.fishpond=a,this.fishpond.debug("Connection created"),this.api_endpoint="http://www.ifish.io/api",this.request_queue=[],this.current_requests=0,this.max_simultaneous_requests=2,this.fishpond.options.development&&(this.fishpond.debug("Development connection selected"),this.api_endpoint="http://"+window.location.host+"/api"),this.fishpond.options.api_endpoint&&(this.api_endpoint=a.options.api_endpoint),this.fishpond.debug("Using API endpoint "+this.api_endpoint)}return a.prototype.api_resource_url=function(a){return[this.api_endpoint,a].join("/")},a.prototype.request=function(a,b,c){return this.send_request(a.join("/"),b,c)},a.prototype.parameterize_data=function(a){var b,d;return b=[],(d=function(a,e){var f,g,h,i,j;j=[];for(h in a)c.call(a,h)&&(i=a[h],i instanceof Array?j.push(function(){var a,b,c;for(c=[],g=a=0,b=i.length;b>a;g=++a)f=i[g],c.push(d(f,null!=e?""+e+"["+h+"][]":""+h+"[]"));return c}()):i instanceof Object?(null!=e?e+="["+h+"]":e=h,j.push(d(i,e))):j.push(b.push(null!=e?""+e+"["+h+"]="+i:""+h+"="+i)));return j})(a,null),b.join("&")},a.prototype.process_request=function(a,b,c){var d,e,f,g,h;return this.fishpond.debug("Requesting "+a),f=this.api_resource_url(a),h=this.fishpond,g=this,d=c,d||(d={}),d.v="1",d.k=h.api_key,e=this.parameterize_data(d),this.connect(f,d,function(a){return h.debug("Success"),h.debug(a),g.current_requests-=1,b(a),g.check_queue_and_process_next()})},a.prototype.check_queue_and_process_next=function(){var a;return this.current_requests<this.max_simultaneous_requests&&this.request_queue.length>0?(this.current_requests+=1,a=this.request_queue.shift(),this.process_request(a.resource,a.callback,a.data)):void 0},a.prototype.send_request=function(a,b,c){return this.request_queue.push({resource:a,callback:b,data:c}),this.check_queue_and_process_next()},a.prototype.connect=JSONP.get,a}(),Fishpond.prototype.get_fish=function(a,b){var c,d;return d=this,d.debug("Sending metadata request for fish "+a),c=this.pond.find_fish(a),c.get_metadata(function(a){return b(a)})},Fishpond.prototype.log=function(a){return this.raw_log("[Fishpond] "+a)},Fishpond.prototype.debug=function(a){return this.options.debug===!0?this.log(a):void 0},Fishpond.prototype.raw_log=function(a){return this.options.quiet!==!0&&console&&console.log?console.log(a):void 0},Fishpond.prototype.arrays_equal=function(a,b){return a.length===b.length&&a.every(function(a){return-1!==b.indexOf(a)})},Fishpond.prototype.array_unique=function(a){var b,c,d,e,f,g;for(c={},b=e=0,f=a.length;f>=0?f>e:e>f;b=f>=0?++e:--e)c[a[b]]=a[b];g=[];for(b in c)d=c[b],g.push(d);return g},Fishpond.prototype.Pond=function(){function a(a){this.fishpond=a}return a.prototype.build=function(a){var b,c,d,e,f,g,h,i,j;for(this.id=a.id,this.name=a.name,this.fish_count=a.fish_count,this.tags=a.tags,this.filters=a.filters,this.tag_ids={community:"community"},this.filter_ids={},this.fish=[],h=this.tags,d=0,f=h.length;f>d;d++)c=h[d],this.tag_ids[c.slug]=c.id;for(i=this.filters,j=[],e=0,g=i.length;g>e;e++)b=i[e],j.push(this.filter_ids[b.slug]=b.id);return j},a.prototype.toString=function(){return this.name},a.prototype.load_all_fish=function(a){return this.fishpond.debug("Loading "+this.fish_count+" fish"),this.load_fish(1,a)},a.prototype.find_fish=function(a){var b,c,d,e;for(e=this.fish,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b;return void 0},a.prototype.default_query_tags=function(){var a,b,c,d,e;for(a={},e=this.tags,c=0,d=e.length;d>c;c++)b=e[c],a[b.id]=10;return a},a.prototype.slugged_tag_name=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.slug},a.prototype.humanized_tag_name=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.name},a.prototype.default_query_filters=function(){var a,b,c,d,e;for(a={},e=this.filters,c=0,d=e.length;d>c;c++)b=e[c],a[b.id]=!1;return a},a.prototype.slugged_filter_name=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.slug},a.prototype.humanized_filter_name=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.name},a.prototype.is_filter=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return!0;return!1},a.prototype.is_tag=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return!0;return!1},a.prototype.get_tag_by_name=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.name===a)return b;return!1},a.prototype.get_tag=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b;return!1},a.prototype.get_filter=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b;return!1},a.prototype.load_fish=function(a,b){var c,d;return d=this,c=this.fishpond,c.connection.request(["ponds",this.id,"fish?page="+a],function(e){var f,g,h,i;for(h=0,i=e.length;i>h;h++)g=e[h],f=new Fishpond.prototype.Fish(d),f.build(g),d.fish.push(f);return c.trigger("loading",d.fish.length/d.fish_count),c.debug("Loaded "+d.fish.length+"/"+d.fish_count),e.length>0?d.load_fish(a+1,b):b()})},a}(),Fishpond.prototype.Fish=function(){function a(a){this.pond=a}return a.prototype.build=function(a){return this.id=a.id,this.title=a.title,this.tags=a.tags,this.community_tags=a.community_tags,this.humanized_tags=[],this.humanized_filters=[],this.is_cached=!1,this.up_voted=!1,this.metadata={},this.humanize_tags()},a.prototype.humanize_tags=function(){var a,b,c,d;c=this.tags,d=[];for(a in c)b=c[a],this.pond.is_tag(a)&&this.humanized_tags.push({name:this.pond.humanized_tag_name(a),slug:this.pond.slugged_tag_name(a),token:a,value:b}),d.push(this.pond.is_filter(a)?this.humanized_filters.push({name:this.pond.humanized_filter_name(a),slug:this.pond.slugged_filter_name(a),token:a,value:b}):void 0);return d},a.prototype.matches_filters=function(a){var b,c,d,e,f,g,h,i;f=!0,c=[],g=[];for(d in a)h=a[d],Boolean(h)&&g.push(this.pond.get_filter(d).group);i=this.pond.filters;for(e in i)b=i[e],a[b.id]&&Boolean(this.tags[b.id])&&Boolean(a[b.id])&&c.push(b.group);return g=Fishpond.prototype.array_unique(g),c=Fishpond.prototype.array_unique(c),0===g.count?!1:Fishpond.prototype.arrays_equal(g,c)},a.prototype.is_filtered=function(a){var b,c,d,e;b=0,d=!0;for(c in a)e=a[c],Boolean(e)&&(b+=1,Boolean(this.tags[c])&&(d=!1));return b>0&&d},a.prototype.popularity=function(){return this.tags.popularity},a.prototype.calculate_score=function(a){var b,c,d,e;c=0,b=this.community_ratio(a);for(d in a)e=a[d],c+=this.calculate_tag_score(d,e,b);return Math.round(c)},a.prototype.calculate_tag_score=function(a,b,c){var d;return b===!1||void 0===this.tags[a]?0:(d=void 0===this.community_tags[a]?this.tags[a]-b:c*this.community_tags[a]+(1-c)*this.tags[a]-b,d*d)},a.prototype.community_ratio=function(a){var b;return b=a.community,void 0===b?0:b/20},a.prototype.add_community_tags=function(a,b){var c,d,e,f,g,h;c={},h=this,d=function(){return b()};for(e in a)g=a[e],f=h.pond.get_tag_by_name(e).id,c[f]=g;return this.pond.fishpond.connection.request(["ponds",this.pond.id,"fish",this.id,"feedbacks"],d,{community_feedback:c})},a.prototype.up_vote=function(){var a;return a=this,this.pond.fishpond.connection.request(["ponds",this.pond.id,"fish",this.id,"up_vote"],function(){return a.up_voted=!0})},a.prototype.load_metadata=function(){return console.warn("Warning `Fishpond::Fish.load_metadata` has been deprecated. Please use `get_metadata` instead.")},a.prototype.get_metadata=function(a){var b;return this.is_cached?a(this):(b=this,this.pond.fishpond.connection.request(["ponds",this.pond.id,"fish",this.id],function(c){return b.metadata=c,b.is_cached=!0,a(b)}))},a}(),Fishpond.prototype.Result=function(){function a(){this.score=void 0,this.fish=void 0}return a}(),Fishpond.prototype.query=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;this.debug("Querying "+this.pond),this.track(this.pond.name,"query","tags:"+JSON.stringify(a)+", filters:"+JSON.stringify(b),this.time_alive()),n=this.pond.default_query_tags(),d=this.pond.default_query_filters();for(i in a)j=a[i],m=this.pond.tag_ids[i],void 0!==m&&(n[m]=j===!1?!1:parseInt(j));for(g in b)h=b[g],c=this.pond.filter_ids[g],void 0!==c&&(d[c]=parseInt(h));for(l=[],s=this.pond.fish,o=0,q=s.length;q>o;o++)e=s[o],e.matches_filters(d)&&(k=new Fishpond.prototype.Result,k.score=e.calculate_score(n),k.fish=e,l.push(k));if(l.sort(function(a,b){return a.score===b.score?0:a.score>b.score?1:a.score<b.score?-1:void 0}),this.event_tracking_enabled)for(f=1,t=l.slice(0,30),p=0,r=t.length;r>p;p++)k=t[p],this.track(k.fish.title,"ranked","",f),f+=1;return this.trigger("resultsUpdated",l.slice(0,30)),!0},Fishpond.prototype.search=function(a){var b,c,d,e,f,g;for(this.debug("Searching for titles like "+a+" in "+this.pond),this.track(this.pond.name,"search",a,this.time_alive()),d=[],g=this.pond.fish,e=0,f=g.length;f>e;e++)b=g[e],c=new Fishpond.prototype.Result,c.score=b.title.score(a),c.fish=b,d.push(c);return d.sort(function(a,b){return a.score===b.score?0:a.score<b.score?1:a.score>b.score?-1:void 0}),d.slice(0,5)}}).call(this);