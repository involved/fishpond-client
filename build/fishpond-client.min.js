/*! fishpond-client v1.2.0 | 2015-02-02 */
"bind"in Function.prototype||(Function.prototype.bind=function(a){var b=this;if(arguments.length<=1)return function(){return b.apply(a,arguments)};var c=Array.prototype.slice.call(arguments,1);return function(){return b.apply(a,0===arguments.length?c:c.concat(Array.prototype.slice.call(arguments)))}}),"trim"in String.prototype||(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(a,b){void 0===b&&(b=0),0>b&&(b+=this.length),0>b&&(b=0);for(var c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(a,b){for(void 0===b&&(b=this.length-1),0>b&&(b+=this.length),b>this.length-1&&(b=this.length-1),b++;b-->0;)if(b in this&&this[b]===a)return b;return-1}),"forEach"in Array.prototype||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d>c;c++)c in this&&a.call(b,this[c],c,this)}),"map"in Array.prototype||(Array.prototype.map=function(a,b){for(var c=new Array(this.length),d=0,e=this.length;e>d;d++)d in this&&(c[d]=a.call(b,this[d],d,this));return c}),"filter"in Array.prototype||(Array.prototype.filter=function(a,b){for(var c,d=[],e=0,f=this.length;f>e;e++)e in this&&a.call(b,c=this[e],e,this)&&d.push(c);return d}),"every"in Array.prototype||(Array.prototype.every=function(a,b){for(var c=0,d=this.length;d>c;c++)if(c in this&&!a.call(b,this[c],c,this))return!1;return!0}),"some"in Array.prototype||(Array.prototype.some=function(a,b){for(var c=0,d=this.length;d>c;c++)if(c in this&&a.call(b,this[c],c,this))return!0;return!1});var JSONP=function(){function a(a,b){var c=document.createElement("script"),d=!1;c.src=a,c.async=!0;var f=b||h.error;"function"==typeof f&&(c.onerror=function(b){f({url:a,event:b})}),c.onload=c.onreadystatechange=function(){d||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(d=!0,c.onload=c.onreadystatechange=null,c&&c.parentNode&&c.parentNode.removeChild(c))},e||(e=document.getElementsByTagName("head")[0]),e.appendChild(c)}function b(a){return encodeURIComponent(a)}function c(c,d,e,i){var j,k=-1===(c||"").indexOf("?")?"?":"&";i=i||h.callbackName||"callback";var l=i+"_json"+ ++f;d=d||{};for(j in d)d.hasOwnProperty(j)&&(k+=b(j)+"="+b(d[j])+"&");return g[l]=function(a){e(a);try{delete g[l]}catch(b){}g[l]=null},a(c+k+i+"="+l),l}function d(a){h=a}var e,f=0,g=this,h={};return{get:c,init:d}}();(function(){var a,b=[].slice,c={}.hasOwnProperty;a="undefined"!=typeof exports&&null!==exports?exports:this,a.Fishpond=function(){function a(b,c){var d;this.api_key=b,this.options=null!=c?c:{},this.created_at=new Date,this._ready=!1,this.log("Creating fishpond instance"),this.connection=new a.prototype.Connection(this),d=this,this.loading(function(a){return d.log("Loading "+100*a+"%")}),this.ready(function(a){return d.log("Ready to query '"+a+"'")}),this.error(function(a){return d.log("Error"),d.log(a)}),this.resultsUpdated(function(a){return d.log("Results updated"),d.raw_log(a)})}return a.prototype.init=function(b){var c;return this.pond_id=b,c=this,this.log("Init with pond "+this.pond_id),c.trigger("loading",0),this.connection.request(["ponds",this.pond_id],function(b){return c.pond=new a.prototype.Pond(c),c.pond.build(b),c.debug("Loaded pond '"+c.pond+"'"),c.pond.load_all_fish(function(){return c.trigger("loading",1),this._ready=!0,c.log("Ready"),c.trigger("ready",c.pond)})})},a.prototype.trigger=function(){var a,c;return c=arguments[0],a=2<=arguments.length?b.call(arguments,1):[],this.callbacks[c](a[0])},a.prototype.time_alive=function(){return parseInt((new Date-this.created_at)/1e3,10)},a.prototype.enable_event_tracking=function(a,b){var c,d,e,f;return this.event_tracking_enabled=!0,f=f||[],f.push(["_setAccount",a]),f.push(["_setDomainName",b]),f.push(["_setAllowLinker",!0]),f.push(["_trackPageview"]),c=document.createElement("script"),c.type="text/javascript",c.async=!0,e="http://www","https:"===document.location.protocol&&(e="https://ssl"),c.src=""+e+".google-analytics.com/ga.js",d=document.getElementsByTagName("script")[0],d.parentNode.insertBefore(c,d),this.log("Event tracking enabled with ID "+a+" on "+b)},a}(),Fishpond.prototype.track=function(a,b,c,d){return this.event_tracking_enabled?(this.log("Tracking: "+a+" | "+b+" | "+c+" | "+d),_gaq.push(["_trackEvent",a,b,c,d])):void 0},Fishpond.prototype.loading=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.loading=a},Fishpond.prototype.ready=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.ready=a},Fishpond.prototype.error=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.error=a},Fishpond.prototype.resultsUpdated=function(a){return this.callbacks||(this.callbacks={}),this.callbacks.resultsUpdated=a},Fishpond.prototype.Connection=function(){function a(a){this.fishpond=a,this.fishpond.debug("Connection created"),this.api_endpoint="http://www.ifish.io/api",this.request_queue=[],this.current_requests=0,this.max_simultaneous_requests=2,this.fishpond.options.development&&(this.fishpond.debug("Development connection selected"),this.api_endpoint="http://"+window.location.host+"/api"),this.fishpond.options.api_endpoint&&(this.api_endpoint=a.options.api_endpoint),this.fishpond.debug("Using API endpoint "+this.api_endpoint)}return a.prototype.api_resource_url=function(a){return[this.api_endpoint,a].join("/")},a.prototype.request=function(a,b,c){return this.send_request(a.join("/"),b,c)},a.prototype.parameterize_data=function(a){var b,d;return b=[],(d=function(a,e){var f,g,h,i,j,k;k=[];for(h in a)c.call(a,h)&&(j=a[h],i=e,j instanceof Array?k.push(function(){var a,b,c;for(c=[],g=a=0,b=j.length;b>a;g=++a)f=j[g],c.push(d(f,null!=i?""+i+"["+h+"][]":""+h+"[]"));return c}()):j instanceof Object?(null!=i?i+="["+h+"]":i=h,k.push(d(j,i))):k.push(b.push(null!=i?""+i+"["+h+"]="+j:""+h+"="+j)));return k})(a,null),b.join("&")},a.prototype.process_request=function(a,b,c){var d,e,f,g,h,i;return this.fishpond.debug("Requesting "+a),g=this.api_resource_url(a),i=this.fishpond,h=this,d=c,d||(d={}),d.v="1",d.k=i.api_key,this.fishpond.options.include_metadata&&(d.m="1"),f=this.parameterize_data(d),e=""+g+"?"+f,this.connect(e,{},function(a){return i.debug("Success"),i.debug(a),h.current_requests-=1,b(a),h.check_queue_and_process_next()})},a.prototype.check_queue_and_process_next=function(){var a;return this.current_requests<this.max_simultaneous_requests&&this.request_queue.length>0?(this.current_requests+=1,a=this.request_queue.shift(),this.process_request(a.resource,a.callback,a.data)):void 0},a.prototype.send_request=function(a,b,c){return this.request_queue.push({resource:a,callback:b,data:c}),this.check_queue_and_process_next()},a.prototype.connect=JSONP.get,a}(),Fishpond.prototype.get_fish=function(a,b){var c,d;return d=this,d.debug("Sending metadata request for fish "+a),c=this.pond.find_fish(a),c.get_metadata(function(a){return b(a)})},Fishpond.prototype.log=function(a){return this.raw_log("[Fishpond] "+a)},Fishpond.prototype.debug=function(a){return this.options.debug===!0?this.log(a):void 0},Fishpond.prototype.raw_log=function(a){return this.options.quiet!==!0&&console&&console.log?console.log(a):void 0},Fishpond.prototype.arrays_equal=function(a,b){return a.length===b.length&&a.every(function(a){return-1!==b.indexOf(a)})},Fishpond.prototype.array_unique=function(a){var b,c,d,e,f,g;for(c={},b=e=0,f=a.length;f>=0?f>e:e>f;b=f>=0?++e:--e)c[a[b]]=a[b];g=[];for(b in c)d=c[b],g.push(d);return g},Fishpond.prototype.Pond=function(){function a(a){this.fishpond=a}return a.prototype.build=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(this.id=a.id,this.name=a.name,this.fish_count=a.fish_count,this.tags=a.tags,this.filters=function(){var c,d,e,f;for(e=a.filters,f=[],c=0,d=e.length;d>c;c++)b=e[c],null===b.category&&f.push(b);return f}(),this.categorized_filters=function(){var c,d,e,f;for(e=a.filters,f=[],c=0,d=e.length;d>c;c++)b=e[c],b.category&&f.push(b);return f}(),this.tag_ids={community:"community"},this.filter_ids={},this.categorized_filters_by_category={},this.fish=[],j=this.tags,d=0,g=j.length;g>d;d++)c=j[d],this.tag_ids[c.slug]=c.id;for(k=this.filters,e=0,h=k.length;h>e;e++)b=k[e],this.filter_ids[b.slug]=b.id;for(l=this.categorized_filters,m=[],f=0,i=l.length;i>f;f++)b=l[f],this.filter_ids[b.slug]=b.id,this.categorized_filters_by_category[b.category]||(this.categorized_filters_by_category[b.category]=[]),m.push(this.categorized_filters_by_category[b.category].push(b));return m},a.prototype.toString=function(){return this.name},a.prototype.load_all_fish=function(a){return this.fishpond.debug("Loading "+this.fish_count+" fish"),this.load_fish(1,a)},a.prototype.find_fish=function(a){var b,c,d,e;for(e=this.fish,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b;return void 0},a.prototype.default_query_tags=function(){var a,b,c,d,e;for(a={},e=this.tags,c=0,d=e.length;d>c;c++)b=e[c],a[b.id]=10;return a},a.prototype.slugged_tag_name=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.slug},a.prototype.humanized_tag_name=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.name},a.prototype.default_query_filters=function(){var a,b,c,d,e;for(a={},e=this.filters.concat(this.categorized_filters),c=0,d=e.length;d>c;c++)b=e[c],a[b.id]=!1;return a},a.prototype.slugged_filter_name=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.slug},a.prototype.humanized_filter_name=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b.name},a.prototype.is_filter=function(a){var b,c,d,e;for(e=this.filters,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return!0;return!1},a.prototype.is_tag=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return!0;return!1},a.prototype.get_tag_by_name=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.name===a)return b;return!1},a.prototype.get_tag=function(a){var b,c,d,e;for(e=this.tags,c=0,d=e.length;d>c;c++)if(b=e[c],b.id===a)return b;return!1},a.prototype.get_filter=function(a){var b,c,d,e,f,g,h;for(g=this.filters,c=0,e=g.length;e>c;c++)if(b=g[c],b.id===a)return b;for(h=this.categorized_filters,d=0,f=h.length;f>d;d++)if(b=h[d],b.id===a)return b;return!1},a.prototype.load_fish=function(a,b){var c,d,e;return e=this,d=this.fishpond,c=function(c){var f,g,h,i;for(h=0,i=c.length;i>h;h++)g=c[h],f=new Fishpond.prototype.Fish(e),f.build(g),e.fish.push(f);return d.trigger("loading",e.fish.length/e.fish_count),d.debug("Loaded "+e.fish.length+"/"+e.fish_count),c.length>0?e.load_fish(a+1,b):b()},d.connection.request(["ponds",this.id,"fish"],c,{page:a})},a}(),Fishpond.prototype.Fish=function(){function a(a){this.pond=a}return a.prototype.build=function(a){return this.id=a.id,this.title=a.title,this.tags=a.tags,this.community_tags=a.community_tags,this.humanized_tags=[],this.humanized_filters=[],this.is_cached=!1,this.up_voted=!1,this.metadata={},this.humanize_tags(),this.ingest_metadata(a)},a.prototype.ingest_metadata=function(a){var b,c,d,e;c=["id","title","tags","community_tags"],e=[];for(b in a)d=a[b],-1===c.indexOf(b)?(this.metadata[b]=d,e.push(this.is_cached=!0)):e.push(void 0);return e},a.prototype.humanize_tags=function(){var a,b,c,d;c=this.tags,d=[];for(a in c)b=c[a],this.pond.is_tag(a)&&this.humanized_tags.push({name:this.pond.humanized_tag_name(a),slug:this.pond.slugged_tag_name(a),token:a,value:parseInt(b,10)}),d.push(this.pond.is_filter(a)?this.humanized_filters.push({name:this.pond.humanized_filter_name(a),slug:this.pond.slugged_filter_name(a),token:a,value:Boolean(parseInt(b,10))}):void 0);return d},a.prototype.matches_filters=function(a){var b,c,d,e,f,g,h,i;f=!0,c=[],g=[];for(d in a)h=a[d],Boolean(parseInt(h,10))&&g.push(this.pond.get_filter(d).group);i=this.pond.filters.concat(this.pond.categorized_filters);for(e in i)b=i[e],b&&a[b.id]&&Boolean(parseInt(this.tags[b.id],10))&&Boolean(parseInt(a[b.id],10))&&c.push(b.group);return g=Fishpond.prototype.array_unique(g),c=Fishpond.prototype.array_unique(c),0===g.count?!1:Fishpond.prototype.arrays_equal(g,c)},a.prototype.popularity=function(){return this.tags.popularity},a.prototype.calculate_score=function(a){var b,c,d,e;c=0,b=this.community_ratio(a);for(d in a)e=a[d],c+=this.calculate_tag_score(d,e,b);return Math.round(c)},a.prototype.calculate_tag_score=function(a,b,c){var d;return b=parseInt(b,10),b===!1||void 0===this.tags[a]?0:(d=void 0===this.community_tags[a]?this.tags[a]-b:c*this.community_tags[a]+(1-c)*this.tags[a]-b,d*d)},a.prototype.community_ratio=function(a){var b;return b=parseInt(a.community,10),void 0===b?0:b/20},a.prototype.add_community_tags=function(a,b){var c,d,e,f,g,h;c={},h=this,d=function(){return b()};for(f in a)g=a[f],e=h.pond.tag_ids[f],c[e]=parseInt(g,10);return this.pond.fishpond.connection.request(["ponds",this.pond.id,"fish",this.id,"feedbacks"],d,{community_feedback:c})},a.prototype.up_vote=function(){var a;return a=this,this.pond.fishpond.connection.request(["ponds",this.pond.id,"fish",this.id,"up_vote"],function(){return a.up_voted=!0})},a.prototype.get_metadata=function(a){var b;return this.is_cached?a(this):(b=this,this.pond.fishpond.connection.request(["ponds",this.pond.id,"fish",this.id],function(c){return b.ingest_metadata(c),a(b)}))},a}(),Fishpond.prototype.Result=function(){function a(){this.score=void 0,this.fish=void 0}return a}(),Fishpond.prototype.query=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;this.debug("Querying "+this.pond),this.track(this.pond.name,"query","tags:"+JSON.stringify(a)+", filters:"+JSON.stringify(b),this.time_alive()),n=this.pond.default_query_tags(),d=this.pond.default_query_filters();for(i in a)j=a[i],m=this.pond.tag_ids[i],void 0!==m&&(n[m]=j===!1?!1:parseInt(j));for(g in b)h=b[g],c=this.pond.filter_ids[g],void 0!==c&&(d[c]=parseInt(h));for(l=[],console.log(d),s=this.pond.fish,o=0,q=s.length;q>o;o++)e=s[o],e.matches_filters(d)&&(k=new Fishpond.prototype.Result,k.score=e.calculate_score(n),k.fish=e,l.push(k));if(l.sort(function(a,b){return a.score===b.score?0:a.score>b.score?1:a.score<b.score?-1:void 0}),this.event_tracking_enabled)for(f=1,t=l.slice(0,30),p=0,r=t.length;r>p;p++)k=t[p],this.track(k.fish.title,"ranked","",f),f+=1;return this.trigger("resultsUpdated",l.slice(0,30)),!0},Fishpond.prototype.search=function(a){var b,c,d,e,f,g;for(this.debug("Searching for titles like "+a+" in "+this.pond),this.track(this.pond.name,"search",a,this.time_alive()),d=[],g=this.pond.fish,e=0,f=g.length;f>e;e++)b=g[e],c=new Fishpond.prototype.Result,c.score=b.title.score(a),c.fish=b,c.score>0&&d.push(c);return d.sort(function(a,b){return a.score===b.score?0:a.score<b.score?1:a.score>b.score?-1:void 0}),d.slice(0,5)},String.prototype.score=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(m=this,m===a)return 1;for(n=m.length,o=0,l=0,g=p=0,q=a.length;q>p;g=++p){if(d=a[g],h=m.indexOf(d.toLowerCase()),i=m.indexOf(d.toUpperCase()),k=Math.min(h,i),j=k>-1?k:Math.max(h,i),-1===j)return 0;e=.1,m[j]===d&&(e+=.1),0===j&&(e+=.8,0===g&&(l=1))," "===m.charAt(j-1)&&(e+=.8),m=m.substring(j+1,n),o+=e}return b=a.length,c=o/b,f=(c*(b/n)+c)/2,l&&1>f+.1&&(f+=.1),f}}).call(this);